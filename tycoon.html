<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Konia Tycoon</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="tycoon-style.css" />
</head>
<body>
  <script>
  const password = prompt("ğŸ® Enter Game Access Code:");
  if (password !== "koniatycoon") {
    alert("âŒ Wrong password. Going back to home.");
    window.location.href = "/";
  }
</script>
  <audio id="bgMusic" autoplay loop>
    <source src="https://cdn.pixabay.com/download/audio/2023/03/07/audio_d7d72be1e7.mp3?filename=relaxing-background-ambient-114566.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
<header class="game-header">
  <div class="game-logo-wrapper">
    <img src="Konia.JPG"alt="Konia Logo" style="height: 100px; width: 130px; margin-right: 10px;">
    <div class="game-logo-text">
      <h1>Konia Tycoon</h1>
      <p>The Gateway to New Economy</p>
    </div>
  </div>
</header>
  <div class="container">
    <!-- Hero Section: Welcome Callout -->
<div class="hero-intro">
  <h2>ğŸš€ Start Mining and Earn KON Daily!</h2>
  <p>Click to mine, upgrade your speed, and claim real tokens to your wallet.</p>
</div>
    <p class="stats">KON Mined: <span id="konCount">0</span></p>
      <div id="nextResetTimerWrapper">
  <p id="nextResetTimer">â³ Next reset in: --:--:--</p>
</div>
    <div class="reward-box">
  <div class="reward-left">
    <span class="reward-icon">ğŸª™</span>
    <span class="reward-title">Reward Pool</span>
  </div>
  <div class="reward-right">
    <span class="reward-value" id="rewardPoolDisplay">Loading...</span>
    <span class="reward-unit">KON Left</span>
  </div>
</div>
        </div><div id="progressBarContainer" title="0 / 5 KON Mined Today">
  <div id="progressBar"></div>
</div>
    <p id="countdownText"></p>
    <p id="limitWarning" style="color: red; font-weight: bold;"></p>
    <div class="top-miner-box">
  <div class="top-miner-icon">ğŸ†</div>
  <div id="topMiner" class="top-miner-name">Top Miner: --</div>
</div>
      <ul id="leaderboard" style="list-style: none; padding: 0;"></ul>
      <p id="topMiner">ğŸ† Top Miner Today: --</p>
    </div>
   <div class="miner-name-box">
  <label for="username" class="miner-label">ğŸ”– Set Miner Name</label>
  <input id="username" placeholder="Enter your miner name" class="miner-input" />
  <button onclick="setUsername()" class="save-btn">ğŸ’¾ Save</button>
</div>
    <button onclick="mineKon()" class="mine-btn">â›ï¸ Mine KON</button>
    <button onclick="buyUpgrade()" class="upgrade-btn">ğŸ›  Buy Upgrade (10 KON)</button>
   <button onclick="claimKonToWallet()" class="advanced-btn">ğŸš€ Claim to Wallet</button>
    <br>
    <button onclick="connectWallet()" class="connect-btn">ğŸ”— Connect Wallet</button>
    <hr>
    <p><strong>Subscription System</strong></p>
    <button onclick="subscribeWithETH()" class="subscribe-btn eth-btn">ğŸ’° Subscribe with ETH</button>
    <button onclick="subscribeWithKON()" class="subscribe-btn kon-btn">ğŸª™ Subscribe with KON</button>
    <p id="subscriptionStatus">Checking subscription status...</p>
   <button id="toggleAutoMining" class="auto-btn" onclick="toggleAutoMining()">âš™ï¸ Enable Auto-Mining</button>
  </div>

 <script>
  // â¬‡ï¸ Paste the full JavaScript code here (starting from `let konCount = ...`)
  // Example:
  let konCount = parseFloat(localStorage.getItem('konCount')) || 0;
  let minedToday = parseFloat(localStorage.getItem('minedToday')) || 0;
  let lastMineDay = localStorage.getItem('lastMineDay') || new Date().toDateString();
  let countdownInterval = null;

async function claimKonToWallet() {
  if (!userAccount) {
    alert("âš ï¸ Please connect your wallet first.");
    return;
  }

  const konCount = parseFloat(localStorage.getItem("konCount") || "0");
  if (konCount <= 0) {
    alert("â›ï¸ You have no KON to claim.");
    return;
  }

  const provider = new ethers.providers.Web3Provider(window.ethereum);
  const signer = provider.getSigner();
  const kon = new ethers.Contract(
    "0x1969eA6A256636C949BeeeBbC15745Dd5Bf5BEDe", // Testnet KONIA
    ["function transfer(address to, uint256 amount) public returns (bool)"],
    signer
  );

  const amount = ethers.utils.parseUnits(konCount.toString(), 18);

  try {
    const tx = await kon.transfer(userAccount, amount);
    await tx.wait();
    alert(`ğŸ‰ Claimed ${konCount} KON!`);
    localStorage.setItem("konCount", "0");
    document.getElementById("konCount").textContent = "0";
  } catch (err) {
    console.error(err);
    alert("âŒ Claim failed. Make sure the contract has enough KON.");
  }
}
function updateProgressBar() {
  const konMined = parseFloat(localStorage.getItem("minedToday")) || 0;
  const dailyLimit = 5.0;
  const percent = Math.min((konMined / dailyLimit) * 100, 100);

  const progressBar = document.getElementById("progressBar");
  const container = document.getElementById("progressBarContainer");

  progressBar.style.width = `${percent}%`;
  progressBar.textContent = `${Math.floor(percent)}%`;
  container.title = `${konMined.toFixed(2)} / ${dailyLimit} KON Mined Today`;

  if (percent < 33) {
    progressBar.style.background = "linear-gradient(to right, #2ecc71, #27ae60)";
  } else if (percent < 66) {
    progressBar.style.background = "linear-gradient(to right, #f1c40f, #f39c12)";
  } else {
    progressBar.style.background = "linear-gradient(to right, #e74c3c, #c0392b)";
  }
}
  function mineKon() {
  const now = Date.now();
  const today = new Date().toDateString();


  if (lastMineDay !== today) {
    minedToday = 0;
    lastMineDay = today;
    localStorage.setItem("lastMineDay", today);
    document.querySelector('button[onclick="mineKon()"]').disabled = false;
    document.getElementById("limitWarning").textContent = "";
  }

  const konPerClick = 0.1;
  const dailyLimit = 5.0;
  const cooldownPeriod = 30 * 60 * 1000; // 30 minutes
  const lastMineTime = parseInt(localStorage.getItem("lastMineTime")) || 0;

  if (now - lastMineTime < cooldownPeriod) {
    const waitTime = cooldownPeriod - (now - lastMineTime);
    const minutesLeft = Math.ceil(waitTime / (60 * 1000));
    document.getElementById("limitWarning").textContent = `â³ Wait ${minutesLeft} min(s) before mining again.`;
    return;
  }

  if (minedToday + konPerClick > dailyLimit) {
    document.getElementById("limitWarning").textContent = "ğŸš« You've reached your daily mining limit.";
    document.querySelector('button[onclick="mineKon()"]').disabled = true;
    return;
  }


  konCount += konPerClick;
  minedToday += konPerClick;
  konCount = parseFloat(konCount.toFixed(4));
  minedToday = parseFloat(minedToday.toFixed(4));
  updateProgressBar(); // update progress visually

// Deduct from the total KON reward pool
totalKonPool = parseFloat(localStorage.getItem("totalKonPool")) || 100000000.0;
totalKonPool -= konPerClick;
localStorage.setItem("totalKonPool", totalKonPool);
document.getElementById("rewardPoolDisplay").textContent = totalKonPool.toFixed(2);

    // ğŸ” Update daily leaderboard
    let username = localStorage.getItem('username') || 'Guest';
  let leaderboard = JSON.parse(localStorage.getItem('dailyLeaderboard')) || {};

  if (!leaderboard[today]) leaderboard[today] = {};
  leaderboard[today][username] = (leaderboard[today][username] || 0) + 0.1;

  localStorage.setItem('dailyLeaderboard', JSON.stringify(leaderboard));


  localStorage.setItem("konCount", konCount);
  localStorage.setItem("minedToday", minedToday);
  localStorage.setItem("lastMineTime", now);
  document.getElementById("konCount").textContent = konCount.toFixed(2);
  document.getElementById("limitWarning").textContent = "";
  totalKonPool = parseFloat(localStorage.getItem("totalKonPool")) || 100000000.0; // Set your desired pool cap
  // ğŸ”’ Disable the button immediately after mining
  document.querySelector('button[onclick="mineKon()"]').disabled = true;
updateLeaderboard();
  startCountdownAfterMine();
}

function updateResetCountdown() {
  console.log("â³ Countdown running...");
  const now = Date.now();
  const lastReset = parseInt(localStorage.getItem("lastMineTime")) || 0;
  const nextReset = lastReset + 30 * 60 * 1000;
  const diff = nextReset - now;

  const mineButton = document.querySelector('button[onclick="mineKon()"]');

if (diff <= 0) {
  document.getElementById("nextResetTimer").textContent = "â³ Ready to mine!";
  mineButton.disabled = false;
  clearInterval(countdownInterval);
} else {
 
  // ğŸ”’ Disable button while countdown is active
  mineButton.disabled = true;
}

  const minutes = Math.floor(diff / 60000);
  const seconds = Math.floor((diff % 60000) / 1000);
  document.getElementById("nextResetTimer").textContent = `â³ Next mine in: ${minutes}m ${seconds}s`;
}

  function startCountdownAfterMine() {
    clearInterval(countdownInterval);
    updateResetCountdown();
    countdownInterval = setInterval(updateResetCountdown, 1000);
    displayTopMiner();
  }

  // Show current count on load
  document.getElementById("konCount").textContent = konCount.toFixed(2);
  startCountdownAfterMine();
   updateProgressBar(); // Show correct progress on load

   // âœ… Place this at the top level (not nested inside any other function)
  function updateLeaderboard() {
    const leaderboardElement = document.getElementById("leaderboard");
    leaderboardElement.innerHTML = ""; // Clear current list

    const leaderboard = JSON.parse(localStorage.getItem("dailyLeaderboard")) || {};
    const today = new Date().toDateString();
    const todayData = leaderboard[today] || {};

    const sorted = Object.entries(todayData).sort((a, b) => b[1] - a[1]);

    for (const [username, score] of sorted) {
      const li = document.createElement("li");
      li.textContent = `${username}: ${score.toFixed(2)} KON`;
      leaderboardElement.appendChild(li);
    }
  }

   function displayTopMiner() {
      const leaderboard = JSON.parse(localStorage.getItem("dailyLeaderboard")) || {};
  const today = new Date().toDateString();
  const todayData = leaderboard[today] || {};

  let topMiner = "";
  let topScore = 0;

  for (let miner in todayData) {
    if (todayData[miner] > topScore) {
      topMiner = miner;
      topScore = todayData[miner];
    }
  }

  document.getElementById("topMiner").textContent = topMiner 
    ? `ğŸ† Top Miner Today: ${topMiner} (${topScore.toFixed(2)} KON)`
    : "No mining yet today.";
}
updateLeaderboard(); // Show leaderboard on page load
// Show the remaining KON reward pool on load
let totalKonPool = parseFloat(localStorage.getItem("totalKonPool")) || 100000000.0;
document.getElementById("rewardPoolDisplay").textContent = totalKonPool.toFixed(2);
startCountdownAfterMine();
</script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
</body>
</html>
